#!/bin/bash

# Run Kibana, using environment variables to set longopts defining Kibana's
# configuration.
#
# eg. Setting the environment variable:
#
#       ELASTICSEARCH_STARTUPTIMEOUT=60
#
# will cause Kibana to be invoked with:
#
#       --elasticsearch.startupTimeout=60

kibana_vars=(
  pkg.version
  pkg.branch
  pkg.buildNum
  pkg.buildSha
  dev.basePathProxyTarget
  pid.exclusive
  csp.rules
  csp.strict
  csp.warnLegacyBrowsers
  cpu
  cpuacct
  server.name
  server.host
  server.port
  server.maxPayloadBytes
  server.autoListen
  server.defaultRoute
  server.basePath
  server.rewriteBasePath
  server.ssl.enabled
  server.ssl.certificateAuthorities
  server.ssl.supportedProtocols
  server.ssl.cipherSuites
  server.cors
  server.xsrf.disableProtection
  server.xsrf.whitelist
  logging.silent
  logging.quiet
  logging.verbose
  logging.dest
  logging.json
  logging.timezone
  ops.interval
  plugins.scanDirs
  plugins.paths
  plugins.initialize
  path.data
  migrations.batchSize
  migrations.scrollDuration
  migrations.pollInterval
  optimize.enabled
  optimize.bundleFilter
  optimize.bundleDir
  optimize.viewCaching
  optimize.watch
  optimize.watchPort
  optimize.watchHost
  optimize.watchPrebuild
  optimize.watchProxyTimeout
  optimize.useBundleCache
  optimize.profile
  status.allowAnonymous
  map.includeElasticMapsService
  map.tilemap.options.default
  map.tilemap.options.minZoom
  map.tilemap.options.maxZoom
  map.regionmap.includeElasticMapsService
  map.regionmap.layers
  map.manifestServiceUrl
  map.emsLandingPageUrl
  i18n.locale
  xpack.xpack_main.enabled
  xpack.xpack_main.telemetry.enabled
  xpack.xpack_main.telemetry.url
  xpack.xpack_main.xpack_api_polling_frequency_millis
  xpack.graph.enabled
  xpack.graph.canEditDrillDownUrls
  xpack.graph.savePolicy
  xpack.monitoring.ccs.enabled
  xpack.monitoring.enabled
  xpack.monitoring.ui.enabled
  xpack.monitoring.ui.container.elasticsearch.enabled
  xpack.monitoring.ui.container.logstash.enabled
  xpack.monitoring.kibana.collection.enabled
  xpack.monitoring.kibana.collection.interval
  xpack.monitoring.cluster_alerts.enabled
  xpack.monitoring.cluster_alerts.email_notifications.enabled
  xpack.monitoring.xpack_api_polling_frequency_millis
  xpack.monitoring.max_bucket_size
  xpack.monitoring.min_interval_seconds
  xpack.monitoring.show_license_expiration
  xpack.monitoring.agent.interval
  xpack.monitoring.elasticsearch.logQueries
  xpack.monitoring.elasticsearch.requestHeadersWhitelist
  xpack.monitoring.elasticsearch.sniffOnStart
  xpack.monitoring.elasticsearch.sniffInterval
  xpack.monitoring.elasticsearch.sniffOnConnectionFault
  xpack.monitoring.elasticsearch.requestTimeout
  xpack.monitoring.elasticsearch.pingTimeout
  xpack.monitoring.elasticsearch.ssl.verificationMode
  xpack.monitoring.elasticsearch.ssl.alwaysPresentCertificate
  xpack.monitoring.elasticsearch.apiVersion
  xpack.monitoring.tests.cloud_detector.enabled
  xpack.spaces.enabled
  xpack.spaces.maxSpaces
  xpack.security.authProviders
  xpack.security.enabled
  xpack.security.cookieName
  xpack.security.sessionTimeout
  xpack.security.secureCookies
  xpack.security.authorization.legacyFallback.enabled
  xpack.security.audit.enabled
  xpack.searchprofiler.enabled
  xpack.ml.enabled
  xpack.tilemap.enabled
  xpack.watcher.enabled
  xpack.grokdebugger.enabled
  xpack.logstash.enabled
  xpack.beats.enabled
  xpack.beats.defaultUserRoles
  xpack.beats.encryptionKey
  xpack.beats.enrollmentTokensTtlInSeconds
  xpack.apm.ui.enabled
  xpack.apm.ui.transactionGroupBucketSize
  xpack.apm.enabled
  xpack.apm.minimumBucketSize
  xpack.apm.bucketTargetCount
  xpack.maps.enabled
  xpack.maps.showMapsInspectorAdapter
  xpack.canvas.enabled
  xpack.canvas.indexPrefix
  xpack.license_management.enabled
  xpack.cloud.enabled
  xpack.index_management.enabled
  xpack.notifications.enabled
  xpack.notifications.email.enabled
  xpack.notifications.email.smtp.host
  xpack.notifications.email.smtp.port
  xpack.notifications.email.smtp.require_tls
  xpack.notifications.email.smtp.pool
  xpack.infra.enabled
  xpack.task_manager.enabled
  xpack.task_manager.max_attempts
  xpack.task_manager.poll_interval
  xpack.task_manager.index
  xpack.task_manager.max_workers
  xpack.rollup.enabled
  xpack.remote_clusters.ui.enabled
  xpack.remote_clusters.enabled
  xpack.ccr.ui.enabled
  xpack.ccr.enabled
  xpack.upgrade_assistant.enabled
  xpack.uptime.enabled
  xpack.oss_telemetry.enabled
  xpack.reporting.enabled
  xpack.reporting.queue.indexInterval
  xpack.reporting.queue.pollEnabled
  xpack.reporting.queue.pollInterval
  xpack.reporting.queue.pollIntervalErrorMultiplier
  xpack.reporting.queue.timeout
  xpack.reporting.capture.zoom
  xpack.reporting.capture.viewport.width
  xpack.reporting.capture.viewport.height
  xpack.reporting.capture.timeout
  xpack.reporting.capture.loadDelay
  xpack.reporting.capture.settleTime
  xpack.reporting.capture.concurrency
  xpack.reporting.capture.browser.type
  xpack.reporting.capture.browser.autoDownload
  xpack.reporting.capture.browser.chromium.disableSandbox
  xpack.reporting.capture.browser.chromium.proxy.enabled
  xpack.reporting.capture.browser.chromium.maxScreenshotDimension
  xpack.reporting.csv.maxSizeBytes
  xpack.reporting.csv.scroll.duration
  xpack.reporting.csv.scroll.size
  xpack.reporting.roles.allow
  xpack.reporting.index
  xpack.reporting.poll.jobCompletionNotifier.interval
  xpack.reporting.poll.jobCompletionNotifier.intervalErrorMultiplier
  xpack.reporting.poll.jobsRefresh.interval
  xpack.reporting.poll.jobsRefresh.intervalErrorMultiplier
  xpack.ilm.enabled
  dashboard_mode.enabled
  console_extensions.enabled
  kuery_autocomplete.enabled
  translations.enabled
  apm_oss.enabled
  apm_oss.indexPattern
  apm_oss.sourcemapIndices
  apm_oss.errorIndices
  apm_oss.transactionIndices
  apm_oss.spanIndices
  apm_oss.metricsIndices
  apm_oss.onboardingIndices
  console.enabled
  console.proxyFilter
  elasticsearch.enabled
  elasticsearch.sniffOnStart
  elasticsearch.sniffInterval
  elasticsearch.sniffOnConnectionFault
  elasticsearch.hosts
  elasticsearch.preserveHost
  elasticsearch.shardTimeout
  elasticsearch.requestTimeout
  elasticsearch.requestHeadersWhitelist
  elasticsearch.pingTimeout
  elasticsearch.startupTimeout
  elasticsearch.logQueries
  elasticsearch.ssl.verificationMode
  elasticsearch.ssl.alwaysPresentCertificate
  elasticsearch.apiVersion
  elasticsearch.healthCheck.delay
  input_control_vis.enabled
  inspector_views.enabled
  interpreter.enabled
  kbn_doc_views.enabled
  kbn_vislib_vis_types.enabled
  kibana.enabled
  kibana.defaultAppId
  kibana.index
  kibana.disableWelcomeScreen
  markdown_vis.enabled
  metric_vis.enabled
  metrics.enabled
  metrics.chartResolution
  metrics.minimumBucketSize
  region_map.enabled
  state_session_storage_redirect.enabled
  status_page.enabled
  table_vis.enabled
  tagcloud.enabled
  testbed.enabled
  tests_bundle.enabled
  tests_bundle.instrument
  tile_map.enabled
  timelion.enabled
  timelion.ui.enabled
  vega.enabled
  vega.enableExternalUrls
  env.name
  env.dev
  env.prod
)

longopts=''
for kibana_var in ${kibana_vars[*]}; do
    # 'elasticsearch.hosts' -> 'ELASTICSEARCH_HOSTS'
    env_var=$(echo ${kibana_var^^} | tr . _)

    # Indirectly lookup env var values via the name of the var.
    # REF: http://tldp.org/LDP/abs/html/bashver2.html#EX78
    value=${!env_var}
    if [[ -n $value ]]; then
      longopt="--${kibana_var}=${value}"
      longopts+=" ${longopt}"
    fi
done

# Files created at run-time should be group-writable, for Openshift's sake.
umask 0002

# The virtual file /proc/self/cgroup should list the current cgroup
# membership. For each hierarchy, you can follow the cgroup path from
# this file to the cgroup filesystem (usually /sys/fs/cgroup/) and
# introspect the statistics for the cgroup for the given
# hierarchy. Alas, Docker breaks this by mounting the container
# statistics at the root while leaving the cgroup paths as the actual
# paths. Therefore, Kibana provides a mechanism to override
# reading the cgroup path from /proc/self/cgroup and instead uses the
# cgroup path defined the configuration properties
# cpu.cgroup.path.override and cpuacct.cgroup.path.override.
# Therefore, we set this value here so that cgroup statistics are
# available for the container this process will run in.

exec /usr/share/kibana/bin/kibana --cpu.cgroup.path.override=/ --cpuacct.cgroup.path.override=/ ${longopts} "$@"
